#!/usr/bin/env bash

USAGE="<branch_name>"
LONG_USAGE="Creates a branch starting from DEVELOPMENT_BRANCH."

source "$(git --exec-path)/git-sh-setup"
source "git-line_utils.bash"

setup_configuration

BRANCH_NAME=$(echo "$2" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' | tr \  -)

if [[ -z $BRANCH_NAME ]] || [[ -n $3 ]]; then
    usage
    exit 1
fi

RANDOM_STRING=$(openssl rand -hex 6)
STASH_NAME="git-line-start-$BRANCH_NAME-$RANDOM_STRING"
git stash push -m $STASH_NAME

git checkout $DEVELOPMENT_BRANCH
git pull --ff-only

if [[ "$BRANCH_PREFIX_ENABLED" == "true" ]]; then
    BRANCH_NAME="$BRANCH_PREFIX/$BRANCH_NAME"
fi

git checkout -b "$BRANCH_NAME"

git stash apply "stash^{/$STASH_NAME}"
